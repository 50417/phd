#!/usr/bin/env python3
#
# Run an OpenCL file.
#
from argparse import ArgumentParser

import os
import pyopencl as cl

import smith
from smith import drive

def main():
    parser = ArgumentParser()
    parser.add_argument('input', help='path to input')
    parser.add_argument('-f', action='store_true', help='treat input as file')
    parser.add_argument('--cpu', action='store_true', default=False,
                        help='execute on CPU (default: no)')
    parser.add_argument('--gpu', action='store_true', default=False,
                        help='execute on GPU (default: yes)')
    parser.add_argument('-q', action='store_true', default=False,
                        help='quiet mode (no compiler output)')
    args = parser.parse_args()

    input_path = args.input
    file_mode = args.f
    use_cpu = args.cpu
    use_gpu = args.gpu  # ignored (default)
    quiet = args.q

    if 'DSIZE' in os.environ:
        dsize = int(os.environ['DSIZE'])
        global_size = (dsize,)
    else:
        global_size = None

    devtype = cl.device_type.CPU if use_cpu else cl.device_type.GPU

    kwargs = { 'global_size': global_size, 'devtype': devtype, 'quiet': quiet }

    if file_mode:
        drive.file(input_path, **kwargs)
    else:
        drive.directory(input_path, **kwargs)

if __name__ == '__main__':
    main()
