#!/usr/bin/env python3
import matplotlib.cm as cm
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import re
import seaborn as sns
import sklearn
import sys

from argparse import ArgumentParser
from math import sqrt,ceil
from functools import partial
from random import seed,random

import labm8
from labm8 import fmt
from labm8 import fs
from labm8 import viz
from labm8 import math as labmath

import smith
from smith import cgo13

# Seaborn configuration:
sns.set(style="ticks", color_codes=True)

data = pd.read_csv(fs.path("data/evalsynthetic.csv"), skipinitialspace=True)

def experiment1(plottype="pdf"):
    def plot_npb(D, platform, outfile=None):
        ax = sns.barplot(x="Group", y="Speedup", hue="Type",
                         data=D[D["Platform"] == platform])
        plt.ylabel("Speedup")
        plt.xlabel("")
        plt.axhline(y=1)
        plt.ylim(0, 6)

        # No legend title
        ax.get_legend().set_title("")

        # Set tick labels
        ticklabels = [re.sub("npb-3.3-", "", d) for d in sorted(list(set(D["Group"])))]
        plt.xticks(np.arange(0, len(ticklabels)), ticklabels)

        return ax

    classifier = "DecisionTree"
    features = "cgo13"

    Bmask = ((data["Training"] == "train(B)") &
            (data["Testing"] == "test(benchmark ⊆ B)") &
            (data["Features"] == features + " features") &
            (data["Classifier"] == classifier))
    B = data[Bmask]

    BSmask = ((data["Training"] == "train(B + S)") &
            (data["Testing"] == "test(benchmark ⊆ B)") &
            (data["Features"] == features + " features") &
            (data["Classifier"] == classifier))
    BS = data[BSmask]

    crows, drows = [], []
    for b,bs in zip(B.iterrows(), BS.iterrows()):
        b, bs = b[1], bs[1]

        def from_perc(x):
            return float(x.strip("%"))
        def toperc(x):
            return str(x) + "%"

        c, d1, d2 = bs, b, bs

        d1["Type"] = "Baseline"
        d2["Type"] = "w. Synthetic kernels"
        if d1["Group"].startswith("npb-"):
            drows.append(d1)
            drows.append(d2)

        c["Accuracy"] = round(from_perc(c["Accuracy"]) /
                              max(from_perc(b["Accuracy"]), 0.01), 2)
        c["Speedup"] = round(c["Speedup"] / b["Speedup"], 2)
        c["Oracle"] = round(from_perc(c["Oracle"]) /
                            max(from_perc(b["Oracle"]), 0.01), 2)
        crows.append(c)

    C = pd.DataFrame(crows)
    D = pd.DataFrame(drows)

    outbase = ("{features}-{group}-{classifier}-"
               .format(features=re.sub(r"\+", "", features),
                       group="benchmark", classifier=classifier))
    csvbase = fs.path("data", outbase)
    imgbase = fs.path("data", "img", outbase)

    fs.mkdir(fs.path("data", "img", "speedup"))

    figsize = (4.5, 2)
    ax = plot_npb(D, "Platform A")
    viz.finalise(fs.path("data", "img", "ex1-A." + plottype),
                 figsize=figsize, tight=True)
    ax = plot_npb(D, "Platform B")
    viz.finalise(fs.path("data", "img", "ex1-B." + plottype),
                 figsize=figsize, tight=True)

    B.to_csv(csvbase + "B.csv", index=False)
    print(csvbase + "B.csv")
    BS.to_csv(csvbase + "BS.csv", index=False)
    print(csvbase + "BS.csv")
    C.to_csv(csvbase + "ratios.csv", index=False)
    print(csvbase + "ratios.csv")


def experiment2(plottype="pdf"):
    def plot_speedups(C, outfile=None):
        def escape_group(g):
            c = g.split('-')
            if c[0] == "amd":
                return "AMD SDK " + c[-1]
            elif c[0] == "nvidia":
                return "Nvidia SDK " + c[-1]
            elif c[0] == "shoc" or c[0] == "npb":
                return c[0].upper() + " " + c[-1]
            else:
                return c[0].capitalize() + " " + c[-1]

        ax = sns.barplot(x="Group", y="Speedup", hue="Platform", data=C,
                         palette=sns.color_palette("Set1", n_colors=2, desat=.8))
        plt.setp(ax.get_xticklabels(), rotation=90)
        plt.ylabel("Speedup")
        plt.xlabel("")
        plt.axhline(y=1)
        plt.ylim(0, 2)

        # No legend title
        ax.get_legend().set_title("")
        plt.legend(loc='upper right')
        ax.get_legend().draw_frame(True)

        # Set tick labels
        ticklabels = [escape_group(d) for d in sorted(list(set(D["Group"])))]
        plt.xticks(np.arange(0, len(ticklabels)), ticklabels)

    classifier = "DecisionTree"
    features = "cgo13+raw"

    Bmask = ((data["Training"] == "train(B)") &
            (data["Testing"] == "test(benchmark ⊆ B)") &
            (data["Features"] == features + " features") &
            (data["Classifier"] == classifier))
    B = data[Bmask]

    BSmask = ((data["Training"] == "train(B + S)") &
            (data["Testing"] == "test(benchmark ⊆ B)") &
            (data["Features"] == features + " features") &
            (data["Classifier"] == classifier))
    BS = data[BSmask]

    crows, drows = [], []
    for b,bs in zip(B.iterrows(), BS.iterrows()):
        b, bs = b[1], bs[1]

        def from_perc(x):
            return float(x.strip("%"))
        def toperc(x):
            return str(x) + "%"

        c, d1, d2 = bs, b, bs

        d1["Type"] = "Baseline"
        d2["Type"] = "w. Synthetic kernels"
        drows.append(d1)
        drows.append(d2)

        c["Accuracy"] = round(from_perc(c["Accuracy"]) /
                              max(from_perc(b["Accuracy"]), 0.01), 2)
        c["Speedup"] = round(c["Speedup"] / b["Speedup"], 2)
        c["Oracle"] = round(from_perc(c["Oracle"]) /
                            max(from_perc(b["Oracle"]), 0.01), 2)
        crows.append(c)

    C = pd.DataFrame(crows)
    D = pd.DataFrame(drows)

    figsize = (10, 5)
    ax = plot_speedups(C)
    viz.finalise(fs.path("data", "img", "ex2." + plottype),
                 figsize=figsize, tight=True)

    outbase = ("{features}-{group}-{classifier}-"
               .format(features=re.sub(r"\+", "", features),
                       group="benchmark", classifier=classifier))
    csvbase = fs.path("data", outbase)

    B.to_csv(csvbase + "B.csv", index=False)
    print(csvbase + "B.csv")
    BS.to_csv(csvbase + "BS.csv", index=False)
    print(csvbase + "BS.csv")
    C.to_csv(csvbase + "ratios.csv", index=False)
    print(csvbase + "ratios.csv")


def main():
    experiment1()
    experiment2()


if __name__ == "__main__":
    main()
