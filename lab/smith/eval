#!/usr/bin/env bash
#
# Create plots.
#

wait_for_jobs() {
    for job in $(jobs -p); do
        wait $job;
    done
}

main() {
    local dir=data/img
    local fmt=png

    rm -rfv $dir
    mkdir -pv $dir

    ########################## BENCHMARKS ##############################
    local benchmarks=benchmarks/data

    # Benchmarks feature space
    smith-plot features $benchmarks/platform-b.csv \
               --group class -o $dir/bench-features-class-B.$fmt \
               --title "Benchmarks results on Platform B" &
    smith-plot features $benchmarks/platform-b.csv \
               --group suite -o $dir/bench-features-suite-B.$fmt \
               --title "Benchmarks results on Platform B" &

    smith-plot features $benchmarks/platform-a.csv \
               --group class -o $dir/bench-features-class-A.$fmt \
               --title "Benchmarks results on Platform A" &
    smith-plot features $benchmarks/platform-a.csv \
               --group suite -o $dir/bench-features-suite-A.$fmt \
               --title "Benchmarks results on Platform A" &

    smith-plot features $benchmarks/training-combined.csv \
               --group class -o $dir/bench-features-class-C.$fmt \
               --title "Benchmarks results for both experimental platforms" &
    smith-plot features $benchmarks/training-combined.csv \
               --group suite -o $dir/bench-features-suite-C.$fmt \
               --title "Benchmarks results for both experimental platforms" &

    # Benchmarks eigen space
    smith-plot eigens $benchmarks/platform-b.csv \
               --group class -o $dir/bench-eigens-class-B.$fmt \
               --title "Benchmarks results on Platform B" &
    smith-plot eigens $benchmarks/platform-b.csv \
               --group suite -o $dir/bench-eigens-suite-B.$fmt \
               --title "Benchmarks results on Platform B" &

    smith-plot eigens $benchmarks/platform-a.csv \
               --group class -o $dir/bench-eigens-class-A.$fmt \
               --title "Benchmarks results on Platform A" &
    smith-plot eigens $benchmarks/platform-a.csv \
               --group suite -o $dir/bench-eigens-suite-A.$fmt \
               --title "Benchmarks results on Platform A" &

    smith-plot eigens $benchmarks/training-combined.csv \
               --group class -o $dir/bench-eigens-class-C.$fmt \
               --title "Benchmarks results for both experimental platforms" &
    smith-plot eigens $benchmarks/training-combined.csv \
               --group suite -o $dir/bench-eigens-suite-C.$fmt \
               --title "Benchmarks results for both experimental platforms" &


    # Cross-benchmark machine learning:
    smith-plot xval $benchmarks/platform-a.csv \
               --group suite -o $dir/bench-xval-bench-A.$fmt \
               --title "Cross-benchmark autotuning on Platform A" &

    smith-plot xval $benchmarks/platform-b.csv \
               --group suite -o $dir/bench-xval-bench-B.$fmt \
               --title "Cross-benchmark autotuning on Platform B" &

    # Nearest-neighbour features
    smith-plot nn $benchmarks/platform-a.csv \
               -o $dir/bench-nn-A.$fmt \
               --title "Distance to nearest neighbour of benchmark features on Platform A" &
    smith-plot nn $benchmarks/platform-b.csv \
               -o $dir/bench-nn-B.$fmt \
               --title "Distance to nearest neighbour of benchmark features on Platform B" &

    # Nearest-neighbour eigens
    smith-plot en $benchmarks/platform-a.csv \
               -o $dir/bench-en-A.$fmt \
               --title "Distance to nearest neighbour of benchmark features on Platform A" &
    smith-plot en $benchmarks/platform-b.csv \
               -o $dir/bench-en-B.$fmt \
               --title "Distance to nearest neighbour of benchmark features on Platform B" &


    wait_for_jobs
    ######################### SYNTHETICS ##############################
    local synthetic=driver/data/synthetic

    # Synthetic feature space
    smith-plot features $synthetic/platform-a.csv \
               --group class \-o $dir/syn-features-class-A.$fmt \
               --title "Synthetic kernels on Platform A" &
    smith-plot features $synthetic/platform-b.csv \
               --group class -o $dir/syn-features-class-B.$fmt \
               --title "Synthetic kernels on Platform B" &
    smith-plot features $synthetic/training-combined.csv \
               --group class -o $dir/syn-features-class-C.$fmt \
               --title "Synthetic kernels for both experimental platforms" &

    # Synthetic eigen space
    smith-plot eigens $synthetic/platform-a.csv \
               --group class \-o $dir/syn-eigens-class-A.$fmt \
               --title "Synthetic kernels on Platform A" &
    smith-plot eigens $synthetic/platform-b.csv \
               --group class -o $dir/syn-eigens-class-B.$fmt \
               --title "Synthetic kernels on Platform B" &
    smith-plot eigens $synthetic/training-combined.csv \
               --group class -o $dir/syn-eigens-class-C.$fmt \
               --title "Synthetic kernels for both experimental platforms" &

    # Noise
    smith-plot ci $synthetic/amd.csv -u -O \
               $synthetic/nvidia.csv $synthetic/intel.csv \
               --title "Runtime vs 95\% CI for synthetic benchmarks" \
               -o $dir/syn-ci.$fmt

    wait_for_jobs
    if which xdg-open &>/dev/null ; then
        xdg-open $dir
    else
        open $dir
    fi
}
main $@
